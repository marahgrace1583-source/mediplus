name: Build and Push to ECR Public

on:
  push:
    branches:
      - main   # Runs only when you push to the main branch

jobs:
  build-push:
    runs-on: ubuntu-latest

    steps:
      # ✅ Step 1: Checkout your repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # ✅ Step 2: Configure AWS credentials
      - name: Configure AWS credentials
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set default.region ${{ secrets.AWS_REGION }}

      # ✅ Step 3: Create ECR Public repository if it doesn't exist
      - name: Create ECR Public repository
        run: |
          aws ecr-public create-repository --repository-name mediplus --region us-east-1 || echo "Repository already exists"

      # ✅ Step 4: Login to Amazon ECR Public
      - name: Login to Amazon ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | \
          docker login --username AWS --password-stdin public.ecr.aws/n5r2a7x5

      # ✅ Step 5: Build and Push Docker image to ECR Public
      - name: Build and Push Docker image
        run: |
          IMAGE_URI=public.ecr.aws/n5r2a7x5/mediplus:${{ github.run_number }}
          echo "Building Docker image: $IMAGE_URI"
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI

      # ✅ Step 5: Display success message
      - name: Deployment Summary
        run: echo "✅ Successfully pushed image to $IMAGE_URI"

