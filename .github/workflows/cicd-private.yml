name: Build and Push to ECR Private

on:
  push:
    branches:
      - main   # Runs only when you push to the main branch

jobs:
  build-push:
    runs-on: ubuntu-latest

    steps:
      # ✅ Step 1: Checkout your repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # ✅ Step 2: Configure AWS credentials
      - name: Configure AWS credentials
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set default.region ${{ secrets.AWS_REGION }}

      # ✅ Step 3: Create ECR repository if it doesn't exist
      - name: Create ECR repository
        run: |
          aws ecr create-repository --repository-name mediplus --region ${{ secrets.AWS_REGION }} || echo "Repository already exists"

      # ✅ Step 4: Login to Amazon ECR Private
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

      # ✅ Step 5: Build and Push Docker image to ECR Private
      - name: Build and Push Docker image
        run: |
          ECR_URI=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/mediplus
          IMAGE_URI=$ECR_URI:${{ github.run_number }}
          echo "Building Docker image: $IMAGE_URI"
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI

      # ✅ Step 5: Display success message
      - name: Deployment Summary
        run: echo "✅ Successfully pushed image to $IMAGE_URI"
